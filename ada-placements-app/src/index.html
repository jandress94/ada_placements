<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <h1>ðŸ’– Hello World!</h1>
    <p>Welcome to your Electron application.</p>
    <p id='loading'></p>
    <ul id='placements'></ul>

    <script type="text/javascript">
    	const electron = require('electron');
    	const {ipcRenderer} = electron;
		const fs = require("fs");
		const parse = require('csv-parse/lib/sync');
		const solver = require("javascript-lp-solver/src/solver");
    	const ul_placements = document.querySelector('#placements');
    	const p_loading = document.querySelector('#loading');

    	ipcRenderer.on('loadScores', function(e, filepath) {
    		p_loading.textContent = "Loading Scores...";

			var data = fs.readFileSync(filepath);
			var records = parse(data.toString(), {
				cast: true,
				columns: false,
				from: 2,
				skip_empty_lines: true,
			});

    		p_loading.textContent = "";
			console.log(records);

			var intVars = {};
			var variables = {};
			var constraints = {};

			for (let index = 0; index < records.length; index++) {
				let row = records[index];
				let personCompanyVar = "var_" + row[0] + "_" + row[1];
				let personConstraint = "person_" + row[0];
				let companyConstraint = "company_" + row[1];
				let overwriteConstraint = "overwrite_" + row[0] + "_" + row[1]

				variables[personCompanyVar] = {
				  [personConstraint]: 1,
				  [companyConstraint]: 1,
				  [overwriteConstraint]: 1,
				  score: row[2]
				}

				let overwrite = row[3].toLowerCase()
				if (overwrite === 'true') {
				  constraints[overwriteConstraint] = { equal: 1 };
				} else if (overwrite === 'false') {
				  constraints[overwriteConstraint] = { equal: 0 };
				}

				intVars[personCompanyVar] = 1

				if (!constraints.hasOwnProperty(personConstraint)) {
				  constraints[personConstraint] = { equal: 1 };
				}

				if (!constraints.hasOwnProperty(companyConstraint)) {
				  constraints[companyConstraint] = { equal: 1 };
				}
			}

			model = {
				optimize: "score",
				opType: "max",
				constraints: constraints,
				variables: variables,
				ints: intVars
			}

			console.log(model);
			let solved_model = solver.Solve(model);
			console.log(solved_model);

			ul_placements.innerHTML = '';
			if (solved_model['feasible']) {
				for (const key in solved_model) {
					if (variables.hasOwnProperty(key)) {
						let li = document.createElement('li');
						li.appendChild(document.createTextNode(key));
						ul_placements.appendChild(li);
					}
				}
			} else {
				let li = document.createElement('li');
				li.appendChild(document.createTextNode('No Solution Possible.'));
				ul_placements.appendChild(li);
			}
    	});
    </script>
  </body>
</html>
